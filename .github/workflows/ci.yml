name: CI Pipeline

on:
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run Ruff linter
        run: |
          ruff check custom_components/ferbos_query_executor/ --output-format=github

      - name: Run Ruff formatter check
        run: |
          ruff format --check custom_components/ferbos_query_executor/

      - name: Check manifest.json
        run: |
          python -c "import json; json.load(open('custom_components/ferbos_query_executor/manifest.json'))"

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run unit tests
        run: |
          pytest tests/ -v --cov=custom_components/ferbos_query_executor --cov-report=xml --cov-report=term

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  integration-tests:
    name: Integration Smoke Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run integration smoke tests
        run: |
          pytest tests/test_integration.py -v -m smoke

  validate-manifest:
    name: Validate Manifest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate manifest.json
        run: |
          python -c "
          import json
          import sys
          
          with open('custom_components/ferbos_query_executor/manifest.json', 'r') as f:
              manifest = json.load(f)
          
          required_fields = ['domain', 'name', 'version', 'codeowners']
          missing = [f for f in required_fields if f not in manifest]
          
          if missing:
              print(f'Missing required fields: {missing}')
              sys.exit(1)
          
          if not isinstance(manifest.get('codeowners', []), list):
              print('codeowners must be a list')
              sys.exit(1)
          
          print('Manifest validation passed')
          "

  check-hacs:
    name: Check HACS Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate hacs.json
        run: |
          python -c "
          import json
          import sys
          
          with open('hacs.json', 'r') as f:
              hacs = json.load(f)
          
          required_fields = ['name', 'domains']
          missing = [f for f in required_fields if f not in hacs]
          
          if missing:
              print(f'Missing required fields in hacs.json: {missing}')
              sys.exit(1)
          
          print('HACS configuration validation passed')
          "

  all-checks:
    name: All Checks Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, validate-manifest, check-hacs]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "All CI checks completed"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Manifest Validation: ${{ needs.validate-manifest.result }}"
          echo "HACS Check: ${{ needs.check-hacs.result }}"


